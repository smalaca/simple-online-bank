<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Customers</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin-bottom: 10px; }
        label { display: inline-block; width: 100px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        tr:hover { background-color: #f5f5f5; cursor: pointer; }
        .actions { cursor: default; }
        .error-message { color: red; font-size: 0.8em; margin-left: 10px; display: none; }
    </style>
</head>
<body>
    <h1>Manage Customers</h1>

    <h2>Add New Customer</h2>
    <div class="form-group">
        <label for="name">Name:</label>
        <input type="text" id="name">
        <span id="error-name" class="error-message"></span>
    </div>
    <div class="form-group">
        <label for="surname">Surname:</label>
        <input type="text" id="surname">
        <span id="error-surname" class="error-message"></span>
    </div>
    <div class="form-group">
        <label for="email">Email:</label>
        <input type="email" id="email">
        <span id="error-email" class="error-message"></span>
    </div>
    <div class="form-group">
        <label for="phoneNumber">Phone:</label>
        <input type="text" id="phoneNumber">
        <span id="error-phoneNumber" class="error-message"></span>
    </div>
    <div class="form-group">
        <label for="address">Address:</label>
        <input type="text" id="address">
        <span id="error-address" class="error-message"></span>
    </div>
    <button onclick="addCustomer()">Add Customer</button>

    <hr>

    <h2>Customer List</h2>
    <table id="customer-table">
        <thead>
            <tr>
                <th>Customer Number</th>
                <th>Name</th>
                <th>Surname</th>
                <th>Email</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="customer-list">
            <!-- Customers will be loaded here -->
        </tbody>
    </table>

    <p><a href="index.html">Back to Home</a></p>

    <script>
        async function loadCustomers() {
            try {
                const response = await fetch('/api/customers');
                const customers = await response.json();
                const list = document.getElementById('customer-list');
                list.innerHTML = '';
                customers.forEach(c => {
                    const tr = document.createElement('tr');
                    tr.onclick = () => window.location.href = `customer-details.html?customerNumber=${c.customerNumber}`;
                    tr.innerHTML = `
                        <td>${c.customerNumber}</td>
                        <td>${c.name}</td>
                        <td>${c.surname}</td>
                        <td>${c.email}</td>
                        <td class="actions">
                            <button onclick="deleteCustomer(event, '${c.customerNumber}')">Delete</button>
                        </td>
                    `;
                    list.appendChild(tr);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function addCustomer() {
            clearErrors();
            const data = {
                name: document.getElementById('name').value,
                surname: document.getElementById('surname').value,
                email: document.getElementById('email').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                address: document.getElementById('address').value
            };

            try {
                const response = await fetch('/api/customers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const responseBody = await response.json();

                    if (Array.isArray(responseBody)) {
                        responseBody.forEach(err => {
                            const errorSpan = document.getElementById(`error-${err.field}`);
                            if (errorSpan) {
                                errorSpan.textContent = err.message;
                                errorSpan.style.display = 'inline';
                            }
                        });
                    } else {
                        loadCustomers();
                        // Clear fields
                        document.getElementById('name').value = '';
                        document.getElementById('surname').value = '';
                        document.getElementById('email').value = '';
                        document.getElementById('phoneNumber').value = '';
                        document.getElementById('address').value = '';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.textContent = '';
                el.style.display = 'none';
            });
        }

        async function deleteCustomer(event, customerNumber) {
            event.stopPropagation(); // Prevent row click event
            if (!confirm('Are you sure you want to delete this customer?')) return;

            try {
                const response = await fetch(`/api/customers/${customerNumber}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.status === 'success') {
                    loadCustomers();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        loadCustomers();
    </script>
</body>
</html>
